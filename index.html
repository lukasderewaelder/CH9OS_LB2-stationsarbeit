<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stationsarbeit - Videoportal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sanfte Übergänge für ein besseres App-Gefühl */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Responsives 16:9 Video-Verhältnis für iFrames */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            width: 100%;
            border-radius: 0.5rem;
            background-color: #000;
        }
        .video-container iframe, .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-md p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                Digitale Stationsarbeit
            </h1>
            <button id="btn-home" class="hidden text-blue-100 hover:text-white font-medium">
                Zurück zur Startseite
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow flex items-center justify-center p-4">
        
        <!-- SECTION: START / CODE ENTRY -->
        <section id="section-login" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg fade-in">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-2">Station wählen</h2>
                <p class="text-gray-500">Bitte gib den Code deiner aktuellen Station ein, um das Video zu starten.</p>
            </div>
            
            <form id="form-login" class="space-y-6">
                <div>
                    <label for="station-code" class="sr-only">Stationscode</label>
                    <input type="text" id="station-code" required autocomplete="off"
                        class="block w-full text-center text-3xl font-bold tracking-widest text-gray-900 uppercase placeholder-gray-300 border-2 border-gray-200 rounded-xl p-4 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all"
                        placeholder="CODE">
                </div>
                <div id="login-error" class="hidden text-red-500 text-sm text-center font-medium bg-red-50 p-2 rounded-lg">
                    Code nicht gefunden. Bitte versuche es erneut.
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    Video starten
                </button>
            </form>

            <div class="mt-8 text-center text-xs text-gray-400">
                Tipp für Lehrkräfte: Code <strong class="text-gray-500">ADMIN</strong> öffnet den Editor.
            </div>
        </section>

        <!-- SECTION: VIDEO PLAYER -->
        <section id="section-video" class="hidden w-full max-w-4xl bg-white p-6 rounded-2xl shadow-lg fade-in">
            <div class="mb-4 flex justify-between items-center border-b pb-4">
                <h2 id="video-title" class="text-2xl font-bold text-gray-900">Stationstitel</h2>
                <span id="video-badge" class="bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full uppercase tracking-wider">CODE</span>
            </div>
            
            <div id="video-wrapper" class="video-container shadow-inner">
                <!-- Video wird hier dynamisch per JS eingefügt -->
            </div>

            <div class="mt-6 text-center">
                <button id="btn-finish-station" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors">
                    Station beenden & Zurück
                </button>
            </div>
        </section>

        <!-- SECTION: ADMIN EDITOR -->
        <section id="section-admin" class="hidden w-full max-w-5xl fade-in flex flex-col gap-6">
            
            <!-- Info Notice -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>Hinweis:</strong> Dies ist eine lokale Version. Die hinzugefügten Stationen werden derzeit nur für diese Sitzung im Browser gespeichert.
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Add Station Form -->
                <div class="bg-white p-6 rounded-2xl shadow-md lg:col-span-1 h-fit">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Neue Station</h2>
                    <form id="form-admin-add" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stationsname / Titel</label>
                            <input type="text" id="add-title" required class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="z.B. Biologie: Die Zelle">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Zugangscode</label>
                            <input type="text" id="add-code" required class="w-full border-gray-300 border rounded-lg p-2 uppercase focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="z.B. BIO1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Video-Typ</label>
                            <select id="add-type" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                                <option value="embed">Einbettungscode (Iframe)</option>
                                <option value="mp4">Direkte .mp4 Datei-URL</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Video-Quelle</label>
                            <!-- Textarea verwendet um ganzen Iframe-Code oder lange URLs besser einfügen zu können -->
                            <textarea id="add-url" required rows="4" class="w-full border-gray-300 border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm" placeholder="<iframe src='...'></iframe>"></textarea>
                            <p class="text-xs text-gray-500 mt-1" id="url-hint">Füge hier den kompletten Einbettungscode (&lt;iframe&gt;...&lt;/iframe&gt;) ein.</p>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-colors flex justify-center items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Speichern
                        </button>
                    </form>
                </div>

                <!-- Station List -->
                <div class="bg-white p-6 rounded-2xl shadow-md lg:col-span-2">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Aktuelle Stationen</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titel</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Typ</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Zeilen werden per JS generiert -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-state" class="hidden text-center py-8 text-gray-500">
                        Keine Stationen vorhanden. Lege links eine neue an!
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // In-Memory Speicher für die Demo
        // Enthält bereits zwei Beispiel-Stationen (1x MP4, 1x Iframe Embed)
        let stations = [
            {
                id: '1',
                code: 'STATION1',
                title: 'Einführung in das Sonnensystem',
                type: 'embed',
                url: '<iframe width="560" height="315" src="https://www.youtube.com/embed/libKVRa01L8?autoplay=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>' // Komplett Iframe Format
            },
            {
                id: '2',
                code: 'LABOR',
                title: 'Labor-Sicherheit (MP4 direkt)',
                type: 'mp4',
                url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4' // Beispiel MP4 URL
            }
        ];

        // --- DOM Elemente ---
        const secLogin = document.getElementById('section-login');
        const secVideo = document.getElementById('section-video');
        const secAdmin = document.getElementById('section-admin');
        const btnHome = document.getElementById('btn-home');
        
        const formLogin = document.getElementById('form-login');
        const inputCode = document.getElementById('station-code');
        const loginError = document.getElementById('login-error');
        
        const videoTitle = document.getElementById('video-title');
        const videoBadge = document.getElementById('video-badge');
        const videoWrapper = document.getElementById('video-wrapper');
        const btnFinishStation = document.getElementById('btn-finish-station');

        const formAdd = document.getElementById('form-admin-add');
        const inputType = document.getElementById('add-type');
        const inputUrl = document.getElementById('add-url');
        const urlHint = document.getElementById('url-hint');
        const adminTableBody = document.getElementById('admin-table-body');
        const emptyState = document.getElementById('empty-state');

        // --- Navigation ---
        function showSection(sectionId) {
            secLogin.classList.add('hidden');
            secVideo.classList.add('hidden');
            secAdmin.classList.add('hidden');
            
            document.getElementById(sectionId).classList.remove('hidden');
            
            // "Zurück" Button in der Kopfzeile anzeigen/verstecken
            if (sectionId === 'section-login') {
                btnHome.classList.add('hidden');
                inputCode.value = '';
                inputCode.focus();
                // Video stoppen wenn wir zurückgehen
                videoWrapper.innerHTML = ''; 
            } else {
                btnHome.classList.remove('hidden');
            }
        }

        // --- Schüler-Ansicht: Login Logik ---
        formLogin.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = inputCode.value.trim().toUpperCase();
            loginError.classList.add('hidden');

            // Prüfen ob es der Admin Code ist
            if (code === 'ADMIN') {
                renderAdminTable();
                showSection('section-admin');
                return;
            }

            // Suchen der Station im Array
            const station = stations.find(s => s.code === code);
            
            if (station) {
                playVideo(station);
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // --- Schüler-Ansicht: Video abspielen ---
        function playVideo(station) {
            videoTitle.textContent = station.title;
            videoBadge.textContent = station.code;
            
            // Alten Inhalt löschen
            videoWrapper.innerHTML = '';

            if (station.type === 'mp4') {
                const videoEl = document.createElement('video');
                videoEl.controls = true;
                videoEl.autoplay = true;
                videoEl.src = station.url;
                videoWrapper.appendChild(videoEl);
            } else if (station.type === 'embed') {
                // Den vom Lehrer eingegebenen Iframe-Code einfügen
                videoWrapper.innerHTML = station.url;

                // 1. WORKAROUND für "Fehler bei Konfiguration des Videoplayers":
                // Fehlende Iframe-Berechtigungen automatisch hinzufügen. Viele Player streiken sonst.
                const iframes = videoWrapper.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    const currentAllow = iframe.getAttribute('allow') || '';
                    // Wenn keine spezifischen Berechtigungen gesetzt sind, erzwinge sie hier:
                    if (!currentAllow.includes('encrypted-media')) {
                        iframe.setAttribute('allow', currentAllow + ' accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen');
                    }
                    iframe.setAttribute('allowfullscreen', 'true');
                });

                // 2. WORKAROUND für "Fehler bei Konfiguration des Videoplayers":
                // Scripts re-evaluieren. Falls der Embed-Code <script>-Tags nutzt, 
                // müssen diese manuell neu geladen werden, da Browser sie via innerHTML sonst ignorieren.
                const scripts = videoWrapper.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.text = oldScript.text;
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            }

            showSection('section-video');
        }

        // --- Buttons zurück zur Startseite ---
        btnHome.addEventListener('click', () => showSection('section-login'));
        btnFinishStation.addEventListener('click', () => showSection('section-login'));

        // --- Admin-Bereich Logik ---

        // Dynamischer Hinweis für die Quellen-Eingabe (Iframe vs MP4 Link)
        inputType.addEventListener('change', () => {
            if (inputType.value === 'embed') {
                urlHint.textContent = "Füge hier den kompletten Einbettungscode (<iframe>...</iframe>) ein.";
                inputUrl.placeholder = "<iframe src='...'></iframe>";
            } else {
                urlHint.textContent = "Bsp: https://meine-schule.de/video.mp4";
                inputUrl.placeholder = "https://...";
            }
        });

        // Neue Station hinzufügen
        formAdd.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newCode = document.getElementById('add-code').value.trim().toUpperCase();
            
            // Prüfen ob Code schon existiert
            if (stations.some(s => s.code === newCode) || newCode === 'ADMIN') {
                alert('Dieser Code existiert bereits oder ist ungültig. Bitte wähle einen anderen.');
                return;
            }

            const newStation = {
                id: Date.now().toString(),
                title: document.getElementById('add-title').value.trim(),
                code: newCode,
                type: document.getElementById('add-type').value,
                url: document.getElementById('add-url').value.trim()
            };

            stations.push(newStation);
            formAdd.reset();
            // Den Hint und Placeholder zurücksetzen falls nötig
            urlHint.textContent = "Füge hier den kompletten Einbettungscode (<iframe>...</iframe>) ein.";
            inputUrl.placeholder = "<iframe src='...'></iframe>";
            
            renderAdminTable();
        });

        // Station löschen
        function deleteStation(id) {
            if (confirm('Möchtest du diese Station wirklich löschen?')) {
                stations = stations.filter(s => s.id !== id);
                renderAdminTable();
            }
        }

        // Tabelle rendern
        function renderAdminTable() {
            adminTableBody.innerHTML = '';
            
            if (stations.length === 0) {
                emptyState.classList.remove('hidden');
                adminTableBody.parentElement.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                adminTableBody.parentElement.classList.remove('hidden');

                stations.forEach(station => {
                    const tr = document.createElement('tr');
                    
                    // Typ Badge
                    const typeColor = station.type === 'mp4' ? 'bg-purple-100 text-purple-800' : 'bg-pink-100 text-pink-800';
                    const typeLabel = station.type === 'mp4' ? 'MP4' : 'Iframe';

                    tr.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="font-mono font-bold text-gray-900 bg-gray-100 px-2 py-1 rounded">${station.code}</span>
                        </td>
                        <td class="px-4 py-4">
                            <div class="text-sm font-medium text-gray-900 truncate max-w-[200px]" title="${station.title}">${station.title}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeColor}">
                                ${typeLabel}
                            </span>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteStation('${station.id}')" class="text-red-600 hover:text-red-900 bg-red-50 p-2 rounded-lg hover:bg-red-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    `;
                    adminTableBody.appendChild(tr);
                });
            }
        }

        // Init Fokus
        inputCode.focus();
    </script>
</body>
</html>